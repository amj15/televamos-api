kind: pipeline
type: docker
name: default

params:
  import_datetime:
    description: Fecha y hora para la importaci√≥n (YYYY-MM-DD HH:mm:ss)
    default: ""


steps:
  - name: build
    image: docker:latest
    environment:
      APP_ENV: prod
      APP_DEBUG: 0
    volumes:
      - name: docker-sock
        path: /var/run/docker.sock
    commands:
      - docker build -t televamos-api:latest -f docker/php/Dockerfile .
  - name: debug-ls
    image: alpine
    commands:
      - ls -la

  - name: deploy
    image: docker/compose:latest
    volumes:
      - name: docker-sock
        path: /var/run/docker.sock
    commands:
      - docker-compose down
      - docker-compose up -d --build
      - docker-compose run --rm php php bin/console doctrine:migrations:migrate --no-interaction

  - name: import-gpx
    image: docker:latest
    depends_on:
      - deploy
    when:
      event: manual
    volumes:
      - name: docker-sock
        path: /var/run/docker.sock
    commands:
      - docker exec symfony_php php DATETIME=${DRONE_BUILD_PARAM_IMPORT_DATETIME:-$(date '+%Y-%m-%d %H:%M:%S')} memory_limit=512M bin/console app:import-gpx "$DATETIME"

volumes:
  - name: docker-sock
    host:
      path: /var/run/docker.sock